name: solar system

on: push

env:
    MONGO_URI: ${{ vars.MONGO_URI }}
    MONGO_USERNAME: ${{ vars.MONGO_USERNAME }}
    MONGO_PASSWORD: ${{ secrets.MONGO_PASSWORD }}


jobs:

  unit-testing: 
      name: unit test
      runs-on: ubuntu-latest

      steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: setup node.js
          uses: actions/setup-node@v4
          with:
            node-version: 18

        - name: Install dependencies
          run: |
            npm install
            npm install --save-dev mocha
            npm install --save-dev mocha-junit-reporter


        - name: npm test
          id: test
          run: npm test

        - name: upload artifact
          if: steps.test == 'failure' || steps.test == 'success'
          uses: actions/upload-artifact@v4
          with:
              name: Mocha-Test-Result
              path: test-results.xml


  code-coverage:
        name: code coverage
        needs: unit-testing
        runs-on: ubuntu-latest

        steps:
          - name: Checkout
            uses: actions/checkout@v4

          - name: setup node.js
            uses: actions/setup-node@v4
            with:
              node-version: 18

          - name: install dependencies
            run: npm install

          - name: npm run coverage
            continue-on-error: true
            run: npm run coverage 

          - name: upload artifact
            uses: actions/upload-artifact@v4
            with:
                name: code-coverage-Result
                path: coverage


  docker: 
      name: containarization
      needs: [unit-testing, code-coverage]
      permissions:
          packages: write
      runs-on: ubuntu-latest

      steps:
          - name: Checkout
            uses: actions/checkout@v4

          - name: docker login
            uses: docker/login-action@v3
            with:
                username: ${{ vars.DOCKER_USERNAME }}
                password: ${{ secrets.DOCKER_PASSWORD }}

          - name: Build 
            uses: docker/build-push-action@v6
            with:
              context: .
              push: flase
              tags: ${{ vars.DOCKER_USERNAME }}/solar-system:${{ github.sha }}

          - name: docker image test
            run: |
                docker images
                docker run --name solar-system-test -d \
                    -p 3000:3000 \
                    -e MONGO_URI=$MONGO_URI \
                    -e MONGO_USERNAME=$MONGO_USERNAME \
                    -e MONGO_PASSWORD=$MONGO_PASSWORD \
                    ${{ vars.DOCKER_USERNAME }}/solar-system:${{ github.sha }}
              
                export IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' solar-system-test)
                echo $IP

                echo "testing image"
                wget -q -O - 127.0.0.1:3000/live | grep live

          - name: Push 
            uses: docker/build-push-action@v6
            with:
              context: .
              push: true
              tags: ${{ vars.DOCKER_USERNAME }}/solar-system:${{ github.sha }}

